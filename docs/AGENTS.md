# AGENTS.md — Контекст для AI-ассистентов

Этот файл содержит информацию о проекте для AI-агентов (Cursor, Copilot и др.).

## О проекте

**Pennora** — приложение для учёта личного и семейного бюджета.

- PWA с полной офлайн-работой
- Синхронизация между устройствами
- Мультивалютность
- Совместные бюджеты

## Технологический стек

### Установлено

| Технология             | Версия  | Назначение                        |
| ---------------------- | ------- | --------------------------------- |
| Next.js                | 16.0.10 | React фреймворк (App Router)      |
| React                  | 19.2.1  | UI библиотека                     |
| TypeScript             | 5.9.3   | Типизация                         |
| Tailwind CSS           | 4.1.18  | CSS фреймворк                     |
| shadcn/ui              | latest  | UI компоненты                     |
| TanStack Query         | 5.90.12 | Серверное состояние и кэширование |
| Zustand                | 5.0.9   | Управление состоянием             |
| next-intl              | 4.6.1   | Интернационализация (i18n)        |
| lucide-react           | latest  | Иконки                            |
| ESLint                 | 9.x     | Линтинг                           |
| Prettier               | 3.7.4   | Форматирование кода               |
| eslint-config-prettier | 10.x    | Интеграция ESLint + Prettier      |
| eslint-plugin-prettier | 5.x     | Prettier как правило ESLint       |

### Планируется

| Технология      | Назначение                  |
| --------------- | --------------------------- |
| Supabase        | База данных, Auth, Realtime |
| Dexie.js        | IndexedDB для офлайн-работы |
| Zod             | Валидация схем              |
| React Hook Form | Работа с формами            |
| Capacitor       | Конвертация PWA → Native    |
| next-pwa        | PWA функциональность        |
| Recharts        | Графики и диаграммы         |

## Пакетный менеджер

Используем **pnpm**. Все команды выполнять через `pnpm`.

## Структура проекта

```
pennora/
├── app/                  # Next.js App Router
│   ├── layout.tsx        # Корневой layout
│   ├── page.tsx          # Главная страница
│   └── globals.css       # Глобальные стили (темы)
├── components/           # React компоненты
│   ├── theme-toggle.tsx  # Переключатель темы
│   ├── locale-toggle.tsx # Переключатель языка
│   └── index.ts          # Экспорты
├── providers/            # React провайдеры
│   ├── theme-provider.tsx# Провайдер темы
│   └── index.ts          # Экспорты
├── i18n/                 # Интернационализация
│   ├── request.ts        # Конфигурация next-intl
│   └── actions.ts        # Server actions для смены языка
├── messages/             # Переводы
│   ├── ru.json           # Русский
│   └── en.json           # English
├── lib/                  # Утилиты
│   ├── query/            # TanStack Query (кеширование)
│   │   ├── client.ts     # Конфигурация QueryClient
│   │   ├── provider.tsx  # QueryClientProvider
│   │   ├── keys.ts       # Query keys factory
│   │   ├── queries/      # Query функции
│   │   └── mutations/    # Mutation хуки
│   ├── hooks/            # React хуки
│   └── utils.ts          # cn() и другие хелперы
├── docs/                 # Документация
│   ├── AGENTS.md         # Этот файл
│   └── CACHING.md        # Документация по кешированию
├── public/               # Статические файлы
├── components.json       # Конфигурация shadcn/ui
├── next.config.ts        # Конфигурация Next.js + next-intl
└── package.json          # Зависимости и скрипты
```

## Темы и локализация

### Темы

- Поддержка светлой, тёмной и системной темы
- По умолчанию — системная тема пользователя
- Цветовая схема: изумрудно-зелёная (`#10b981` / `#00dc82`)
- CSS переменные в `globals.css`
- Класс `.dark` на `<html>` для тёмной темы

### Локализация (i18n)

- Поддержка русского и английского языков
- По умолчанию — язык из Accept-Language браузера, иначе русский
- Переводы в `messages/*.json`
- Смена языка через cookie `locale`

## Правила разработки

### Код

- Использовать TypeScript для всего кода
- Следовать принципам Clean Code: осмысленные имена, маленькие функции, DRY, KISS, SOLID
- Комментарии на русском языке
- TODO-комментарии для задач на будущее

### Стиль кода

- ESLint и Prettier для форматирования
- НЕ править стиль вручную — запускать `pnpm lint:fix` и `pnpm format`
- Конфигурация в `.prettierrc` и `eslint.config.mjs`

### Импорты

- Использовать алиас `@/*` для импортов из корня проекта
- Пример: `import { Button } from "@/components/ui/button"`

## Команды

```bash
pnpm dev           # Запуск dev-сервера
pnpm build         # Сборка проекта
pnpm lint          # Проверка ESLint
pnpm lint:fix      # Автоисправление ESLint
pnpm format        # Форматирование Prettier
pnpm format:check  # Проверка форматирования
```

## Архитектурные решения

### Кеширование данных

**ВАЖНО:** Все данные, которые загружаются из Supabase или других источников, должны кешироваться через TanStack Query.

**См. подробную документацию:** [`docs/CACHING.md`](./CACHING.md)

**Основные правила:**

- ✅ Кешировать данные, которые используются при переходах между вкладками
- ✅ Кешировать данные, используемые в нескольких компонентах
- ✅ Кешировать редко меняющиеся данные (категории, настройки)
- ✅ Использовать оптимистичные обновления для мутаций
- ✅ Инвалидировать кеш при изменениях данных
- ❌ НЕ кешировать временные данные (токены, сессии)
- ❌ НЕ кешировать данные, которые должны быть всегда свежими

**При добавлении новых данных:**

1. Создать query функцию в `lib/query/queries/`
2. Добавить query key в `lib/query/keys.ts`
3. Использовать `useQuery` в компонентах
4. Создать mutations в `lib/query/mutations/` при необходимости

**Примеры кеширования:**

- Транзакции: `staleTime: 2 минуты` (часто меняются)
- Категории: `staleTime: 10 минут` + персистентность (редко меняются)
- Курсы валют: `staleTime: 1 час` (обновляются раз в час)
- Счета: `staleTime: 10 минут` (редко меняются)

### Офлайн-first

- Все операции сначала сохраняются в IndexedDB (Dexie.js)
- При подключении к сети — синхронизация с Supabase
- Оптимистичные обновления UI через TanStack Query

### Синхронизация

- Supabase Realtime для обновлений в реальном времени
- Очередь синхронизации для офлайн-операций
- Разрешение конфликтов: Last-Write-Wins или выбор пользователя
- Автоматическая инвалидация кеша TanStack Query при изменениях

### Мультивалютность

- Базовая валюта бюджета для агрегации
- Хранение транзакций в исходной валюте
- Исторические курсы для корректной отчётности
- Кеширование курсов валют через TanStack Query

### Совместные бюджеты

- Роли: owner, editor, viewer
- Row Level Security (RLS) в Supabase
- Приглашения по email
