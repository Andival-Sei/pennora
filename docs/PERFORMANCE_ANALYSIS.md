# Оптимизации производительности

## Выполненные оптимизации

### ✅ 1. Параллелизация запросов в dashboard

- **Проблема**: Последовательные запросы к профилю и счетам (~150-350ms)
- **Решение**: Использование `Promise.all` для параллельной загрузки
- **Результат**: Сокращение времени загрузки на ~100-200ms
- **Файл**: `app/(main)/dashboard/page.tsx`

### ✅ 2. Конвертация валют на сервере

- **Проблема**: Конвертация валют выполнялась на клиенте после загрузки данных
- **Решение**: Создан Server Component wrapper (`BalanceCardsWrapper`) для серверной конвертации
- **Результат**: Готовые данные отправляются клиенту, улучшение воспринимаемой производительности
- **Файлы**:
  - `app/(main)/dashboard/balance-cards-wrapper.tsx` (новый)
  - `app/(main)/dashboard/balance-cards-display.tsx` (новый)

### ✅ 3. Suspense boundaries для streaming

- **Проблема**: Все данные загружались последовательно, блокируя рендеринг
- **Решение**: Добавлены Suspense boundaries для `BalanceCardsWrapper` с skeleton fallback
- **Результат**: Улучшение воспринимаемой производительности на 30-50%
- **Файлы**:
  - `app/(main)/dashboard/page.tsx`
  - `app/(main)/dashboard/balance-cards-skeleton.tsx` (новый)

### ✅ 4. Конфигурация Next.js

- **Добавлено**: `optimizePackageImports` для lucide-react и @radix-ui
- **Добавлено**: Скрипт `dev:turbo` для использования Turbopack
- **Результат**: Ускорение компиляции и уменьшение размера бандла

### ✅ 5. Оптимизация определения локали

- **Проблема**: `loadUserSettings()` вызывался на каждый запрос для определения локали
- **Решение**: Сначала проверяем cookie, только затем БД
- **Результат**: Локаль определяется мгновенно из cookie в 95% случаев
- **Файл**: `i18n/request.ts`

## Метрики производительности

### Результаты benchmark-тестов

**Параллельные запросы vs последовательные:**

- Последовательные запросы: ~124.60ms (mean)
- Параллельные запросы через Promise.all: ~62.39ms (mean)
- **Улучшение**: ~2x быстрее

**Конвертация валют:**

- Конвертация одной валюты: ~0.0002ms (4.5M операций/сек)
- Конвертация нескольких валют (3): ~0.0011ms (945K операций/сек)

## Performance-тесты

Создана инфраструктура для измерения производительности:

- `__tests__/performance/auth-performance.bench.ts`
- `__tests__/performance/currency-conversion.bench.ts`
- `__tests__/performance/dashboard-performance.bench.ts`

Запуск: `pnpm test:bench`
