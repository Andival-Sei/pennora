# Roadmap: Pennora

**Версия:** 1.4.0
**Статус MVP:** 85% — базовый функционал готов
**Цель:** Довести проект до production-ready состояния

---

## Обзор

Pennora — трекер личного/семейного бюджета с offline-first архитектурой. Основной функционал реализован (транзакции, счета, категории, синхронизация, PWA). Этот roadmap описывает путь от MVP к стабильному, качественному продукту.

---

## Фаза 1: Стабилизация

> Цель: Устранить технический долг и подготовить проект к production

### 1.1 Логирование и мониторинг ✅

**Проблема:** В коде 50+ мест с console.log/error, которые попадают в production.

**Задачи:**

- [x] Заменить все `console.error` в `lib/sync/syncManager.ts` на `captureError()` из Sentry
- [x] Заменить все `console.error` в `lib/utils/errorHandler.ts` на Sentry
- [x] Заменить `console.log/error` в `app/(main)/dashboard/accounts/page.tsx`
- [x] Заменить `console.error` в `lib/db/indexeddb/persister.ts`
- [x] Создать утилиту `lib/utils/logger.ts` с условным логированием (только в dev)
- [x] Удалить отладочные console.log в `lib/receipt/processor.ts`

**Результат:** Чистая консоль в production, все ошибки в Sentry

### 1.2 Покрытие тестами

**Текущее состояние:** 45% покрытия (24 файла тестов)

**Задачи:**

- [x] Добавить тесты для `lib/sync/syncManager.ts` (критичный модуль) — 48 тестов, 96% покрытие
- [x] Добавить тесты для `lib/sync/queueManager.ts` — 46 тестов, 97% покрытие
- [ ] Добавить тесты для `lib/query/mutations/*.ts`
- [ ] Добавить тесты для `lib/hooks/useSync.ts`
- [ ] Добавить тесты для `lib/receipt/processor.ts`
- [ ] Добавить интеграционные тесты для auth flow
- [x] Настроить CI/CD для запуска тестов при каждом PR

**Цель:** 50% покрытия к концу фазы

### 1.3 Типизация

**Проблема:** 4 места с `any` в production коде

**Задачи:**

- [ ] Исправить типизацию в `components/ui/chart.tsx` (заменить `any` на `unknown` + type guards)
- [ ] Исправить типизацию в `components/ui/google-button.tsx`
- [ ] Провести аудит оставшихся `eslint-disable` комментариев

---

## Фаза 2: Производительность

> Цель: Оптимизировать скорость работы и размер бандла

### 2.1 Мемоизация компонентов

**Проблема:** Только 4% компонентов используют `memo()`, 18% используют `useCallback/useMemo`

**Задачи:**

- [ ] Обернуть `app/demo/demo-dashboard.tsx` в `memo()`
- [ ] Обернуть `components/ui/chart.tsx` в `memo()`
- [ ] Добавить `useCallback` для обработчиков в `components/features/categories/CategoryForm.tsx`
- [ ] Добавить `useCallback` в `components/features/transactions/CascadingCategorySelect.tsx`
- [ ] Добавить `useCallback` в `components/features/transactions/ReceiptCamera.tsx`
- [ ] Провести аудит компонентов с >300 строк на предмет оптимизации

### 2.2 Skeleton Loaders

**Задачи:**

- [ ] Создать `TransactionListSkeleton` для списка транзакций
- [ ] Создать `StatisticsPageSkeleton` для страницы статистики
- [ ] Создать `CategoryListSkeleton` для списка категорий
- [ ] Заменить `LoadingState` на skeleton loaders в критичных местах

### 2.3 Оптимизация бандла

**Задачи:**

- [ ] Запустить `pnpm analyze` и проанализировать отчёт
- [ ] Оптимизировать импорты из `date-fns` (только нужные функции)
- [ ] Проверить tree-shaking для `lucide-react`
- [ ] Рассмотреть замену `recharts` на более лёгкую альтернативу (если размер критичен)

---

## Фаза 3: Завершение функционала

> Цель: Реализовать недостающие функции из TODO комментариев

### 3.1 Поиск по транзакциям

**Задачи:**

- [ ] Реализовать `components/features/transactions/TransactionFilters.tsx`
- [ ] Добавить поле поиска в `TransactionPageContent.tsx`
- [ ] Обновить `fetchTransactions` в `lib/query/queries/transactions.ts` для поддержки поиска
- [ ] Создать хук `lib/hooks/useDebounce.ts`
- [ ] Интегрировать debounce (300-500ms) для поиска

### 3.2 Модуль валют

**Задачи:**

- [ ] Реализовать `lib/types/currency.ts` (типы уже заглушка)
- [ ] Реализовать `components/features/currency/CurrencySelector.tsx`
- [ ] Реализовать `components/features/currency/CurrencyConverter.tsx`
- [ ] Реализовать `lib/hooks/useCurrency.ts`

### 3.3 Модуль бюджетов

**Задачи:**

- [ ] Реализовать `lib/types/budget.ts` (типы уже заглушка)
- [ ] Реализовать `components/features/budgets/BudgetCard.tsx`
- [ ] Реализовать `components/features/budgets/BudgetForm.tsx`
- [ ] Реализовать `lib/hooks/useBudgets.ts`
- [ ] Добавить query и mutation для бюджетов

### 3.4 Синхронизация

**Задачи:**

- [ ] Реализовать `lib/sync/conflictResolver.ts` (алгоритм разрешения конфликтов)
- [ ] Улучшить индикатор прогресса синхронизации
- [ ] Добавить retry с exponential backoff для failed операций

### 3.5 Stores

**Задачи:**

- [ ] Реализовать `lib/stores/authStore.ts` (состояние аутентификации)
- [ ] Реализовать `lib/stores/uiStore.ts` (UI состояние: модалки, сайдбары)

---

## Фаза 4: Безопасность

> Цель: Hardening для production

### 4.1 HTTP Headers

**Задачи:**

- [ ] Настроить Content Security Policy (CSP) в `next.config.ts`
- [ ] Добавить Permissions-Policy header
- [ ] Проверить работу приложения с новыми headers

### 4.2 Rate Limiting

**Задачи:**

- [ ] Добавить rate limiting для mutations на клиенте
- [ ] Рассмотреть использование `p-limit` или аналога
- [ ] Ограничить частоту запросов к Exchange Rate API

### 4.3 Зависимости

**Текущее состояние:** 1 moderate уязвимость (eml-parser → request)

**Задачи:**

- [ ] Мониторить обновления `eml-parser`
- [ ] Исследовать альтернативы для парсинга EML (mailparser)
- [ ] Добавить ограничение размера файла для EML
- [ ] Включить Dependabot alerts в GitHub

### 4.4 Email и SMTP

**Задачи:**

- [ ] Выбрать SMTP провайдера (Resend, SendGrid, AWS SES)
- [ ] Настроить SMTP в Supabase Dashboard
- [ ] Настроить DKIM, DMARC, SPF для домена
- [ ] Включить подтверждение email после настройки

---

## Фаза 5: UX улучшения

> Цель: Улучшить пользовательский опыт

### 5.1 Accessibility

**Задачи:**

- [ ] Добавить `aria-label` для иконок без текста
- [ ] Добавить `aria-describedby` для сложных элементов
- [ ] Улучшить focus management в модальных окнах
- [ ] Проверить контрастность цветов
- [ ] Добавить skip links для навигации

### 5.2 Экспорт/Импорт

**Задачи:**

- [ ] Реализовать экспорт транзакций в CSV
- [ ] Реализовать экспорт в JSON
- [ ] Реализовать импорт из CSV с валидацией
- [ ] Добавить UI для экспорта/импорта в настройках

### 5.3 Улучшение статистики

**Задачи:**

- [ ] Добавить графики трендов (line charts)
- [ ] Добавить сравнение периодов
- [ ] Добавить фильтрацию по категориям в статистике
- [ ] Реализовать экспорт графиков

---

## Фаза 6: E2E тестирование

> Цель: Обеспечить стабильность критичных сценариев

### 6.1 Настройка Playwright

**Задачи:**

- [ ] Установить и настроить Playwright
- [ ] Создать базовые helpers и fixtures
- [ ] Настроить CI для E2E тестов

### 6.2 Критичные сценарии

**Задачи:**

- [ ] Тест: Регистрация → Онбординг → Создание счёта
- [ ] Тест: Создание транзакции (доход/расход/перевод)
- [ ] Тест: Редактирование и удаление транзакции
- [ ] Тест: Работа в офлайн-режиме
- [ ] Тест: Синхронизация при восстановлении сети

---

## Фаза 7: Layouts и документация

> Цель: Подготовить к публичному релизу

### 7.1 Layouts

**Задачи:**

- [ ] Реализовать `components/layouts/MainLayout.tsx`
- [ ] Реализовать `components/layouts/AuthLayout.tsx`
- [ ] Рефакторинг существующих layouts для использования новых компонентов

### 7.2 Документация

**Задачи:**

- [ ] Обновить README.md с инструкциями по деплою
- [ ] Создать инструкцию по настройке Supabase проекта
- [ ] Документировать API endpoints
- [ ] Создать contributing guide

---

## Будущие возможности (Post-MVP)

> Не включены в текущий roadmap, но планируются

### Совместные бюджеты

- Модель для совместных бюджетов
- Система приглашений
- Управление правами доступа

### Повторяющиеся транзакции

- Модель для recurring transactions
- UI для создания и управления
- Автоматическое создание по расписанию

### Теги для транзакций

- Модель тегов
- UI для управления
- Фильтрация и статистика по тегам

### Мобильное приложение (Capacitor)

- Настройка Capacitor
- Push уведомления
- Биометрическая аутентификация
- Нативная интеграция с камерой

### 2FA

- TOTP через Supabase Auth
- Backup codes
- Recovery flow

---

## Метрики успеха

| Метрика                  | Текущее | Цель          |
| ------------------------ | ------- | ------------- |
| Test coverage            | 45%     | 70%           |
| Console.log в production | 0       | 0             |
| Компоненты с memo()      | 4%      | 30%           |
| E2E тесты                | 0       | 10+ сценариев |
| Lighthouse Performance   | ?       | ≥90           |
| Lighthouse Accessibility | ?       | ≥90           |
| Ошибки в Sentry (daily)  | ?       | <10           |

---

## Порядок выполнения

```
Фаза 1 (Стабилизация)
    ├── 1.1 Логирование
    ├── 1.2 Тесты
    └── 1.3 Типизация
            │
            ▼
Фаза 2 (Производительность)
    ├── 2.1 Мемоизация
    ├── 2.2 Skeletons
    └── 2.3 Бандл
            │
            ▼
Фаза 3 (Функционал)    ◄───  Параллельно с Фазой 4
    ├── 3.1 Поиск
    ├── 3.2 Валюты
    ├── 3.3 Бюджеты
    ├── 3.4 Синхронизация
    └── 3.5 Stores
            │
            ▼
Фаза 4 (Безопасность)
    ├── 4.1 Headers
    ├── 4.2 Rate Limiting
    ├── 4.3 Зависимости
    └── 4.4 SMTP
            │
            ▼
Фаза 5 (UX)
    ├── 5.1 Accessibility
    ├── 5.2 Экспорт/Импорт
    └── 5.3 Статистика
            │
            ▼
Фаза 6 (E2E)
    ├── 6.1 Playwright
    └── 6.2 Сценарии
            │
            ▼
Фаза 7 (Релиз)
    ├── 7.1 Layouts
    └── 7.2 Документация
```

---

**Последнее обновление:** 2026-01-01
