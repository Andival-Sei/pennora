# Обработка чеков

## Обзор

Pennora поддерживает автоматическое создание транзакций из чеков с помощью OCR (оптического распознавания символов) и парсинга данных. Функционал позволяет загружать чеки в различных форматах: изображения, PDF файлы и EML (email) файлы.

## Поддерживаемые форматы

### 1. Изображения (фото чеков)

- **Форматы**: JPEG, PNG, WebP и другие форматы изображений
- **Источники**:
  - Фото с камеры устройства
  - Загрузка изображений из файловой системы
- **Обработка**:
  - Чтение QR-кода ФНС (если присутствует)
  - OCR распознавание текста через Tesseract.js
  - Парсинг данных из распознанного текста

### 2. PDF файлы

- **Форматы**: PDF документы с текстом или отсканированными изображениями
- **Источники**: Загрузка PDF файлов
- **Обработка**:
  - Извлечение текста из PDF через pdfjs-dist
  - Парсинг данных из извлеченного текста
  - Поддержка многостраничных PDF

### 3. EML файлы (email письма)

- **Форматы**: EML файлы (стандартный формат сохранения email)
- **Источники**: Загрузка EML файлов (например, сохраненных писем из почтового клиента)
- **Обработка**:
  - Извлечение вложений (PDF или изображения) из письма
  - Поиск чеков в тексте письма
  - Обработка всех найденных чеков
  - API route для парсинга EML на сервере (`/api/receipts/parse-email`)

## Процесс обработки

### Для изображений и PDF

1. **Чтение QR-кода** (только для изображений)
   - Поиск QR-кода ФНС на изображении
   - Парсинг данных из QR-кода (дата, сумма, ФН, ФД, ФП)
   - Приоритет данных из QR-кода над OCR

2. **Извлечение текста**
   - Для изображений: OCR через Tesseract.js (русский + английский языки)
   - Для PDF: извлечение текста через pdfjs-dist
   - Отслеживание прогресса обработки

3. **Парсинг данных**
   - Извлечение даты из текста
   - Определение суммы чека
   - Парсинг описания (название товара или продавца)
   - Определение способа оплаты (наличные/карта)
   - Извлечение списка товаров (опционально)

4. **Формирование результата**
   - Создание объекта `ReceiptData`
   - Валидация данных (проверка суммы и даты)
   - Возврат результата или ошибки

### Для EML файлов

1. **Извлечение вложений**
   - Парсинг EML файла через API route
   - Поиск вложений (PDF или изображения)
   - Поиск чеков в тексте письма

2. **Обработка каждого найденного чека**
   - Применение стандартного процесса обработки для каждого файла
   - Поддержка обработки нескольких чеков из одного письма

3. **Формирование результатов**
   - Массив результатов обработки для каждого чека

## Технологии

### OCR (Оптическое распознавание символов)

- **Библиотека**: [Tesseract.js](https://tesseract.projectnaptha.com/)
- **Языки**: Русский (rus) и английский (eng)
- **Использование**: Только для изображений, не для PDF с текстовым слоем

### PDF обработка

- **Библиотека**: [pdfjs-dist](https://mozilla.github.io/pdf.js/)
- **Worker**: Локальный worker из `/public/pdf.worker.min.mjs`
- **Возможности**: Извлечение текста из всех страниц PDF

### QR-код распознавание

- **Библиотека**: [jsQR](https://github.com/cozmo/jsQR)
- **Формат**: QR-коды ФНС (Федеральная налоговая служба России)
- **Данные**: Дата, сумма, ИНН, номер фискального накопителя, фискальный документ

### EML парсинг

- **API Route**: `/api/receipts/parse-email`
- **Библиотека**: `eml-parser` (на сервере)
- **Возможности**: Извлечение вложений и текста письма

## Структура кода

### Основные файлы

```
lib/receipt/
├── types.ts              # TypeScript типы для чеков
├── processor.ts          # Главный процессор (координация)
├── ocr.ts                # OCR обработка (Tesseract.js, pdfjs-dist)
├── qr-reader.ts          # Чтение QR-кодов
├── parser.ts             # Парсинг текста чеков
├── email-parser.ts       # Обработка EML файлов
├── category-matcher.ts   # Сопоставление категорий
├── merchant-database.ts  # База известных магазинов и нормализация
└── ...

components/features/transactions/
├── ReceiptInputDialog.tsx  # Диалог выбора метода ввода
├── ReceiptUploader.tsx     # Компонент загрузки файлов
├── ReceiptCamera.tsx       # Компонент камеры
└── TransactionForm.tsx     # Форма транзакции (использует данные чека)

app/api/receipts/
└── parse-email/
    └── route.ts           # API route для парсинга EML
```

### Основные типы

```typescript
interface ReceiptData {
  date: Date;
  amount: number;
  description: string | null;
  merchant: string | null; // Название продавца/магазина (нормализованное)
  paymentMethod: "cash" | "card" | null;
  items?: Array<{ name: string; price: number }>;
  suggestedCategoryId?: string | null;
}

interface ReceiptProcessingResult {
  success: boolean;
  data?: ReceiptData;
  error?: string;
  rawText?: string;
  qrData?: string;
}

type ReceiptFileType = "image" | "pdf" | "eml" | "text";
```

## Пользовательский интерфейс

### Методы ввода чека

1. **Загрузка файла** (`ReceiptUploader`)
   - Поддержка изображений, PDF и EML
   - Drag & drop (через input)
   - Превью загруженного файла
   - Прогресс-бар обработки

2. **Фото с камеры** (`ReceiptCamera`)
   - Доступ к камере устройства
   - Захват фото чека
   - Обработка в реальном времени

3. **Ручной ввод** (`TransactionForm`)
   - Прямой ввод данных транзакции
   - Форма без обработки чека

### Интеграция с формой транзакции

После обработки чека данные автоматически заполняются в форму создания транзакции:

- Дата
- Сумма
- Описание (автоматически генерируется для сплит-транзакций)
- Магазин/продавец (нормализованное название)
- Способ оплаты
- Предложенная категория (через `category-matcher.ts`)
- Позиции товаров (для сплит-транзакций)

## Парсинг данных

### Парсинг даты

Поддерживаемые форматы:

- `DD.MM.YYYY HH:MM`
- `DD.MM.YYYY`
- `YYYY-MM-DD HH:MM`
- `YYYY-MM-DD`

### Парсинг суммы

Приоритетные паттерны (в порядке важности):

1. `ИТОГ = 900.00`
2. `СУММА ПО ЧЕКУ (БСО) 900.00`
3. `ИТОГО: 900.00`
4. `К ОПЛАТЕ: 900.00`

Если не найдено по паттернам, ищется наибольшее число в тексте.

### Парсинг описания

**Для одиночных позиций (1 товар):**

- Используется название товара

**Для сплит-транзакций (несколько позиций):**

- Генерируется общее описание в формате: `"Категория из Магазина"` (например, "Готовая еда из Самокат")
- Если категория не определена: `"Покупка из Магазина"`
- Если магазин не определён: `"Покупка (N позиций)"`

**Определение магазина:**

- Поиск доменов в тексте (samokat.ru → "Самокат")
- Поиск юридических названий (ООО, ИП)
- Поиск известных магазинов по ключевым словам
- Нормализация через базу известных магазинов (`merchant-database.ts`)

**База известных магазинов:**
Система содержит базу известных магазинов с их вариантами названий:

- Юридические названия (ООО, ИП)
- Домены сайтов
- Ключевые слова
- Предполагаемые категории

Примеры: Самокат, Пятёрочка, Магнит, Яндекс.Лавка и др.

### Парсинг способа оплаты

Определяется по ключевым словам:

- **Наличные**: "НАЛИЧНЫМИ", "НАЛИЧНЫЕ", "CASH"
- **Карта**: "КАРТОЙ", "КАРТА", "БЕЗНАЛИЧНЫЙ", "CARD", "DEBIT", "CREDIT"

### Парсинг товаров

Парсер использует блочный подход для извлечения товаров из российских кассовых чеков:

**Основной формат (российские чеки):**

- `1: Название товара`
  - Название извлекается из строки с номером позиции
  - Цена находится в блоке "Общая стоимость позиции..." (может быть в той же строке или следующей)
  - Пропускаются служебные строки: "1 шт. x 186.00", "Ставка НДС", "Способ расчета", "Признак предмета расчета"

**Альтернативный формат:**

- `Название товара    123.45` (цена в конце строки)
  - Используется только если нет пронумерованных позиций

**Фильтрация служебных строк:**
Парсер автоматически игнорирует служебные строки:

- Строки с количеством ("1 шт. x", "x 186.00")
- Итоговые суммы ("ИТОГ", "ИТОГО", "= 858.00")
- Платежи ("ЗАЧЕТ ПРЕДОПЛАТЫ", "НАЛИЧНЫМИ", "БЕЗНАЛИЧНЫМИ")
- НДС и налоговые данные ("Ставка НДС", "СУММА НДС ЧЕКА")
- Другие служебные поля чека

**Ранний выход:**
Обработка товаров прекращается при встрече маркеров конца секции:

- "ИТОГ", "ИТОГО"
- "СУММА ПО ЧЕКУ"
- "ЗАЧЕТ", "ПРЕДОПЛАТ", "АВАНС"

## Обработка ошибок

### Типичные ошибки

1. **Не удалось распознать текст**
   - Низкое качество изображения
   - Неподдерживаемый формат

2. **Не удалось определить сумму**
   - Некорректный формат чека
   - Плохое качество OCR

3. **Не найдено вложений в EML**
   - Нет PDF или изображений во вложениях
   - Чек не найден в тексте письма

### Сообщения об ошибках

Все сообщения об ошибках локализованы через `next-intl`:

- Русский: `messages/ru.json`
- Английский: `messages/en.json`

Ключи сообщений: `receipts.errors.*`

## Производительность

### Оптимизации

1. **Прогресс обработки**
   - Отслеживание прогресса OCR через callback
   - Плавная интерполяция прогресса (через `useSmoothProgress`)
   - Визуальная обратная связь для пользователя

2. **Приоритет QR-кода**
   - Если найден QR-код, данные из него имеют приоритет
   - Меньше необходимости в OCR для чеков с QR-кодом

3. **Обработка PDF**
   - Прямое извлечение текста (быстрее OCR)
   - Поддержка многостраничных документов

### Ограничения

- OCR может быть медленным на больших изображениях
- Качество распознавания зависит от качества исходного изображения
- Поддержка в основном российских чеков (ФНС формат)

## Автоматическая генерация описаний

Система автоматически генерирует описания для транзакций из чеков:

### Логика генерации

1. **Одиночная позиция**: Используется название товара
2. **Несколько позиций (сплит-транзакция)**:
   - Формат: `"Категория из Магазина"` (например, "Готовая еда из Самокат")
   - Если категория не определена: `"Покупка из Магазина"`
   - Если магазин не определён: `"Покупка (N позиций)"`

### Определение магазина

Система определяет магазин несколькими способами:

1. **По доменам**: Ищет домены в тексте (samokat.ru → "Самокат")
2. **По юридическим названиям**: ООО, ИП и т.д.
3. **По ключевым словам**: Поиск известных магазинов
4. **Нормализация**: Использование базы известных магазинов

### База известных магазинов

Файл `merchant-database.ts` содержит базу известных магазинов с:

- Понятными названиями для пользователя
- Юридическими названиями
- Доменами сайтов
- Ключевыми словами
- Предполагаемыми категориями

Примеры магазинов: Самокат, Пятёрочка, Магнит, Яндекс.Лавка, Delivery Club и др.

## Будущие улучшения

- [x] Автоматическая генерация описаний для сплит-транзакций
- [x] База известных магазинов
- [x] Нормализация названий магазинов
- [ ] Расширение базы известных магазинов
- [ ] Улучшение точности парсинга для различных форматов чеков
- [ ] Поддержка других форматов QR-кодов (не только ФНС)
- [ ] Машинное обучение для автоматического определения категорий
- [ ] Кэширование результатов OCR для одинаковых чеков
- [ ] Поддержка чеков из других стран
- [ ] Экспорт чеков в различные форматы

## Документация связанных модулей

- **[ARCHITECTURE.md](./ARCHITECTURE.md)** — общая архитектура проекта
- **[CACHING.md](./CACHING.md)** — система кеширования
- **[OFFLINE_SYNC.md](./OFFLINE_SYNC.md)** — офлайн-режим и синхронизация
